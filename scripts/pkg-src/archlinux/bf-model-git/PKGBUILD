# Maintainer: Jed Liu <jliu@barefootnetworks.com>
pkgname=bf-model-git
pkgver=r0
pkgrel=1
pkgdesc="BFN: architecture-accurate models"
arch=('x86_64')
url="https://github.com/barefootnetworks/model"
license=('custom')
depends=('libcli' 'libcrafter' 'rapidjson' 'bf-drivers')
provides=("${pkgname%-git}")
conflicts=("${pkgname%-git}")

_gitbranch='master'
_giturl='git@github.com:barefootnetworks/model'

prepare() {
  cd "${srcdir}"
  git clone -b "${_gitbranch}" "${_giturl}" "${pkgname%-git}"
}

pkgver() {
  cd "${srcdir}/${pkgname%-git}"
  printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

build() {
  cd "${srcdir}/${pkgname%-git}"
  builddir="."
  if [ -r opt/Makefile ]; then
    builddir=opt
  elif [ -r debug/Makefile ]; then
    builddir=debug
  fi

  cd $builddir
  ./autogen.sh
  ./configure --prefix=/usr --sbin=/usr/bin \
    --enable-runner --enable-simple-test-harness \
    --disable-runner-static
  make
}

package() {
  cd "${srcdir}/${pkgname%-git}"
  make -j1 DESTDIR="${pkgdir}/" install
}
