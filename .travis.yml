services:
- docker

notifications:
    slack: barefootnetworks:DLConaMwl9V5JAlA3hErnoSE#brig-travis

branches:
  only:
  - master
  - stable

before_install:
  - nproc
  - free -m

# do not need to clone the submodules since we're using the docker image
# build by Jenkins
git:
  submodules: false

env:
  global:
    - MAKEFLAGS="-j4"
    - PULL_TIMEOUT=3600
    - DOCKER_USERNAME="bfndocker"
    - DOCKERFILE="docker/Dockerfile.tofino"
    - secure: "jE3hbAEwkQZCH/3BsGBHCTPi4r72Lhum1cEw3sC/87BHLCz3C6txsZuFUKopj+/cAS/HPITSjFagkb0L3cYhXNwt5jT8Imu+TMdmClX4w9uOxbk98ecEHl0Gou9sEm0DDk6yHuzneLaLfaQDZayIA/48LvkYxSVbBMDSkEyQfD5UjAYCRxN8r+rucazeG5m7875p7sXAd1QkeFg8svL0KdQJBjn82e6oFxPNQvG9aXu5YaIvJ8vB2jrwa1a8IKg4KKJbI/Mj3+5qdbe+U8+4Jm36IpMROAe9Fyt2eiGFgPe+Cvp6ZNkh/vYFt7V+EW0rpuK5N6K5sEYL34/sMLLHbaSjFawpskR337PUACdP5NgWLNb/wmZC1V7gRYBbtOEZVJlQFCTTeN1ik7ziCdLC5kEUPHIWHN3U5EhQQ/RkAaM4+MXohx3top1pP8HIcD0r434F90alICYGPBRstkgmWKO9/9qR0JJ5KAzRgbS3Xp6fWifodlYGjnCIpZd7/L5hJPENu5y3vAJgsiqn3yLIvPER9QXY858Io0GhJ3/Q0oIr4qF+sOWvUUWRrLHFO7TDL6q/BiZ45vdEBQoukqzXN4me/E/CbP4Vv3fpcmu3COe/R/v44zkh1d8ZzbgABgbi1v9HjW5PadwNP8HDABjerL0pwLCxOGWqlYgvWTotU2g="
    - TOFINO_TESTS_1="^tofino/"
    - TOFINO_EXCLUDE_1="smoketest|/programs|/internal_p4_14|p4testgen|tofino/switch_|c2_COMPILER|c2/COMPILER|p4_16_programs|/p4_16/customer/extreme/p4c-1([^3]|3[^1]).*"
    - TOFINO_EXCLUDE_LABEL_1="GTS_WEEKLY|NON_PR_TOFINO"
    - TOFINO_TESTS_2="^tofino/(.*programs|.*internal_p4_14)"
    - TOFINO_EXCLUDE_2="TestRealData|_basic_ipv4|_stful|_meters|_hash_driven|_dkm|_exm_smoke_test|_exm_direct_|_exm_direct_1_|p4_16_programs_tna_exact_match|p4_16_programs_tna_meter_lpf_wred|perf_test_alpm|entry_read_from_hw"
    - JBAY_TESTS="^tofino2|cpplint|gtest|test_p4c_driver"
    - JBAY_EXCLUDE="ignore_test_|smoketest|p4_16_programs_tna_exact_match|p4_16_programs_tna_meter_lpf_wred|/p4_16/customer/extreme/p4c-1([^3]|3[^1]).*|/dkm/|entry_read_from_hw|/p4_14/stf/decaf_9.*"

cache:
  # timeout waiting for docker images
  timeout: $PULL_TIMEOUT
  directories:
  - $HOME/.ccache

jobs:
  include:
    - stage: build
      script:
        - export DOCKER_TAG=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then echo $TRAVIS_COMMIT; else echo $TRAVIS_PULL_REQUEST_SHA; fi)
        - echo "DOCKER_TAG=$DOCKER_TAG"
        - ./docker/docker_wait.py --image amr-registry.caas.intel.com/bxd-sw/bf-p4c-compilers:$DOCKER_TAG --timeout $PULL_TIMEOUT --username $DOCKER_USERNAME --password $DOCKER_PASSWORD
    - stage: test
      # Run all tofino tests excluding smoketests
      script: ./docker/docker_ctest.sh --suite "$TOFINO_TESTS_1" --exclude "$TOFINO_EXCLUDE_1" --exclude_label "$TOFINO_EXCLUDE_LABEL_1"
    - stage: test
      # Run all tofino smoke tests
      script: ./docker/docker_ctest.sh --suite "$TOFINO_TESTS_2" --exclude "$TOFINO_EXCLUDE_2"
    - stage: test
      # Run all jbay tests (including cpplint and gtest)
      script: ./docker/docker_ctest.sh --suite "$JBAY_TESTS" --exclude "$JBAY_EXCLUDE"

stages:
  build
  test
