#!/bin/bash

fast=false;

while expr "$1" : - >/dev/null; do
    case $1 in
    -f) fast=true
        ;;
    -*)
        echo >&2 "unknown argumnet $1"
        ;;
    esac
    shift
done

trap 'exit' 2

if [ $# -eq 0 ]; then
    set *.p4
fi

rm -rf faillog.txt
FAILLOG=$(pwd -P)/faillog.txt

GLSC=$HOME/p4c-tofino/p4c_tofino/shell.py
pass=0
fail=0

for f in "$@"; do
    echo -n $f
    pushd $(dirname $f) >/dev/null
    name=$(basename $f .p4)
    mkdir -p $name.out
    cd $name.out
    ok=true
    if $fast && [ -r $name.tfa ]; then
        need_reflow=false
    elif $GLSC --verbose 2 -S ../$name.p4 >glsc.log 2>&1; then
        need_reflow=true
    else
        echo " p4 compile failed"
        let fail++
        echo "$f:" >> $FAILLOG
        cat glsc.log >> $FAILLOG
        ok=false
    fi
    if $ok && tfas -vvvl tfas.config.log $name.tfa >tfas.log 2>&1; then
        for f in $name.out/*.json; do
            if reflow $f >tmp.json; then
                mv tmp.json $f
            fi
            if $need_reflow && reflow $(basename $f) >tmp.json; then
                mv tmp.json $(basename $f)
            fi
            diff -u $f $(basename $f)
        done > json_diff.txt
        cnt=$(grep -Ev '^\+\+\+|^---|"int_inj"' json_diff.txt | grep -Ec '^\+|^-')
        if [ $cnt -gt 0 ]; then
            echo " mismatch"
            let fail++
            echo "$f:" >> $FAILLOG
            cat json_diff.txt >> $FAILLOG
        else
            echo " pass"
            let pass++
        fi
    elif $ok; then
        echo " tfas failed"
        let fail++
        echo "$f:" >> $FAILLOG
        cat tfas.log >> $FAILLOG
        ok=false
    fi
    popd >/dev/null
done

echo "$pass tests passed, $fail tests fail"
